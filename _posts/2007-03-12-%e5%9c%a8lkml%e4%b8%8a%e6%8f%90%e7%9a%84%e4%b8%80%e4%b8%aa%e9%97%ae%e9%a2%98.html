---
layout: post
title: 在LKML上提的一个问题
date: 2007-03-12 15:36:47.000000000 -07:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Linux Kernel
tags: []
meta:
  _publicize_pending: '1'
  original_post_id: '51'
  _wp_old_slug: '51'
author:
  login: wangcong2015
  email: wangcong@rocketmail.com
  display_name: wangcong2015
  first_name: ''
  last_name: ''
permalink: "/2007/03/12/%e5%9c%a8lkml%e4%b8%8a%e6%8f%90%e7%9a%84%e4%b8%80%e4%b8%aa%e9%97%ae%e9%a2%98/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<html><body>
<p>发件人         Cong WANG<br />
收件人         linux-kernel@vger.kernel.org<br />
日期        2007-3-11 下午10:15<br />
主题        Style Question<br />
邮送域        gmail.com<br />
Hi, list!</p>
<p>I have a question about coding style in linux kernel. In<br />
Documention/CodingStyle, it is said that "Linux style for comments is<br />
the C89 "/* ... */" style. Don't use C99-style "// ..." comments."<br />
_But_ I see a lot of '//' style comments in current kernel code.</p>
<p>Which is wrong? The documentions or the code, or neither? And why?</p>
<p>Another question is about NULL. AFAIK, in user space, using NULL is<br />
better than directly using 0 in C. In kernel, I know it used its own<br />
NULL, which may be defined as ((void*)0), but it's _still_ different<br />
from raw zero. So can I say using NULL is better than 0 in kernel?</p>
<p>Any reply is welcome. Thanks and have a nice day!</p>
<p>Bernd Petrovitsch 第一个回答到：</p>
<p>On Sun, 2007-03-11 at 22:15 +0800, Cong WANG wrote:<br />
[...]<br />
&gt; Another question is about NULL. AFAIK, in user space, using NULL is<br />
&gt; better than directly using 0 in C. In kernel, I know it used its own<br />
&gt; NULL, which may be defined as ((void*)0),</p>
<p>Userspace has the usually same definition.</p>
<p>&gt;                                           but it's _still_ different<br />
&gt; from raw zero.</p>
<p>It is different that "0" as such has the type "int". But this int is<br />
automatically promoted to a "0 pointer".</p>
<p>&gt;                So can I say using NULL is better than 0 in kernel?</p>
<p>Yes, because it is immediately clear that a pointer is (or should be)<br />
there (and not an int).<br />
And the same holds for userspace since this is a pure C question.</p>
<p>Bernd</p>
<p>Jan Engelhardt 回复到：</p>
<p>On Mar 11 2007 22:15, Cong WANG wrote:<br />
&gt;<br />
&gt; I have a question about coding style in linux kernel. In<br />
&gt; Documention/CodingStyle, it is said that "Linux style for comments is<br />
&gt; the C89 "/* ... */" style. Don't use C99-style "// ..." comments."<br />
&gt; _But_ I see a lot of '//' style comments in current kernel code.<br />
&gt;<br />
&gt; Which is wrong? The documentions or the code, or neither? And why?</p>
<p>The code. And because it's not always reviewed but silently pushed.</p>
<p>&gt; Another question is about NULL. AFAIK, in user space, using NULL is<br />
&gt; better than directly using 0 in C. In kernel, I know it used its own<br />
&gt; NULL, which may be defined as ((void*)0), but it's _still_ different<br />
&gt; from raw zero.</p>
<p>In what way?</p>
<p>&gt;So can I say using NULL is better than 0 in kernel?</p>
<p>On what basis? Do you even know what NULL is defined as in<br />
(C, not C++) userspace? Think about it.</p>
<p>Jan</p>
<p>我看到后回复：</p>
<p>2007/3/12, Jan Engelhardt:<br />
&gt;<br />
&gt; On Mar 11 2007 22:15, Cong WANG wrote:<br />
&gt; &gt;<br />
&gt; &gt; I have a question about coding style in linux kernel. In<br />
&gt; &gt; Documention/CodingStyle, it is said that "Linux style for comments is<br />
&gt; &gt; the C89 "/* ... */" style. Don't use C99-style "// ..." comments."<br />
&gt; &gt; _But_ I see a lot of '//' style comments in current kernel code.<br />
&gt; &gt;<br />
&gt; &gt; Which is wrong? The documentions or the code, or neither? And why?<br />
&gt;<br />
&gt; The code. And because it's not always reviewed but silently pushed.<br />
&gt;<br />
&gt; &gt; Another question is about NULL. AFAIK, in user space, using NULL is<br />
&gt; &gt; better than directly using 0 in C. In kernel, I know it used its own<br />
&gt; &gt; NULL, which may be defined as ((void*)0), but it's _still_ different<br />
&gt; &gt; from raw zero.<br />
&gt;<br />
&gt; In what way?</p>
<p>The following code is picked from drivers/kvm/kvm_main.c:</p>
<p>static struct kvm_vcpu *vcpu_load(struct kvm *kvm, int vcpu_slot)<br />
{<br />
struct kvm_vcpu *vcpu = &amp;kvm-&gt;vcpus[vcpu_slot];</p>
<p>mutex_lock(&amp;vcpu-&gt;mutex);<br />
if (unlikely(!vcpu-&gt;vmcs)) {<br />
mutex_unlock(&amp;vcpu-&gt;mutex);<br />
return 0;<br />
}<br />
return kvm_arch_ops-&gt;vcpu_load(vcpu);<br />
}</p>
<p>Obviously, it used 0 rather than NULL when returning a pointer to<br />
indicate an error. Should we fix such issue?</p>
<p>&gt;<br />
&gt; &gt;So can I say using NULL is better than 0 in kernel?<br />
&gt;<br />
&gt; On what basis? Do you even know what NULL is defined as in<br />
&gt; (C, not C++) userspace? Think about it.<br />
&gt;</p>
<p>I think it's more clear to indicate we are using a pointer rather than<br />
an integer when we use NULL in kernel. But in userspace, using NULL is<br />
for portbility of the program, although most (*just* most, NOT all) of<br />
NULL's defination is ((void*)0).</p>
<p>一些其它的回复如下：</p>
<p>Robert Hancock 写道：</p>
<p>Cong WANG wrote:<br />
&gt; Hi, list!<br />
&gt;<br />
&gt; I have a question about coding style in linux kernel. In<br />
&gt; Documention/CodingStyle, it is said that "Linux style for comments is<br />
&gt; the C89 "/* ... */" style. Don't use C99-style "// ..." comments."<br />
&gt; _But_ I see a lot of '//' style comments in current kernel code.<br />
&gt;<br />
&gt; Which is wrong? The documentions or the code, or neither? And why?</p>
<p>The code.. As with a lot of coding style issues, it's likely just that<br />
nobody saw it and bothered to complain when it went in.</p>
<p>&gt; Another question is about NULL. AFAIK, in user space, using NULL is<br />
&gt; better than directly using 0 in C. In kernel, I know it used its own<br />
&gt; NULL, which may be defined as ((void*)0), but it's _still_ different<br />
&gt; from raw zero. So can I say using NULL is better than 0 in kernel?</p>
<p>It's the preferred style, Sparse will complain about using 0 for a null<br />
pointer for example..</p>
<p>Mac的Kyle Moffett 如是说：</p>
<p>On Mar 11, 2007, at 16:41:51, Daniel Hazelton wrote:<br />
&gt; On Sunday 11 March 2007 16:35:50 Jan Engelhardt wrote:<br />
&gt;&gt; On Mar 11 2007 22:15, Cong WANG wrote:<br />
&gt;&gt;&gt; So can I say using NULL is better than 0 in kernel?<br />
&gt;&gt;<br />
&gt;&gt; On what basis? Do you even know what NULL is defined as in (C, not<br />
&gt;&gt; C++) userspace? Think about it.<br />
&gt;<br />
&gt; IIRC, the glibc and GCC headers define NULL as (void*)0  :)</p>
<p>On the other hand when __cplusplus is defined they define it to the<br />
"__null" builtin, which GCC uses to give type conversion errors for<br />
"int foo = NULL" but not "char *foo = NULL".  A "((void *)0)"<br />
definition gives C++ type errors for both due to the broken C++ void<br />
pointer conversion problems.</p>
<p>Cheers,</p>
<p>Nicholas Miell这样说：</p>
<p>On Mon, 2007-03-12 at 06:40 +0100, Jan Engelhardt wrote:<br />
&gt; On Mar 12 2007 13:37, Cong WANG wrote:<br />
&gt; &gt;<br />
&gt; &gt; The following code is picked from drivers/kvm/kvm_main.c:<br />
&gt; &gt;<br />
&gt; &gt; static struct kvm_vcpu *vcpu_load(struct kvm *kvm, int vcpu_slot)<br />
&gt; &gt; {<br />
&gt; &gt; struct kvm_vcpu *vcpu = &amp;kvm-&gt;vcpus[vcpu_slot];<br />
&gt; &gt;<br />
&gt; &gt; mutex_lock(&amp;vcpu-&gt;mutex);<br />
&gt; &gt; if (unlikely(!vcpu-&gt;vmcs)) {<br />
&gt; &gt; mutex_unlock(&amp;vcpu-&gt;mutex);<br />
&gt; &gt; return 0;<br />
&gt; &gt; }<br />
&gt; &gt; return kvm_arch_ops-&gt;vcpu_load(vcpu);<br />
&gt; &gt; }<br />
&gt; &gt;<br />
&gt; &gt; Obviously, it used 0 rather than NULL when returning a pointer to<br />
&gt; &gt; indicate an error. Should we fix such issue?<br />
&gt;<br />
&gt; Indeed. If it was for me, something like that should throw a compile error.<br />
&gt;<br />
&gt; &gt;&gt;[...]<br />
&gt; &gt; I think it's more clear to indicate we are using a pointer rather than<br />
&gt; &gt; an integer when we use NULL in kernel. But in userspace, using NULL is<br />
&gt; &gt; for portbility of the program, although most (*just* most, NOT all) of<br />
&gt; &gt; NULL's defination is ((void*)0).</p>
<p>&gt;<br />
&gt; NULL has the same bit pattern as the number zero. (I'm not saying the bit<br />
&gt; pattern is all zeroes. And I am not even sure if NULL ought to have the same<br />
&gt; pattern as zero.) So C++ could use (void *)0, if it would let itself :p</p>
<p>Not necessarily. You can use 0 at the source level, but the compiler has<br />
to convert it to the actual NULL pointer bit pattern, whatever it may<br />
be.</p>
<p>In C++, NULL is typically defined to 0 (with no void* cast) by most<br />
compilers because 0 (and only 0) can be implicitly converted to to null<br />
pointer of any ponter type without a cast.</p>
<p>GCC introduced the __null extension so that NULL still works correctly<br />
in C++ when passed to a varargs function on 64-bit platforms.</p>
<p>(This just works in C because C makes NULL ((void*)0) is thus is the<br />
right size. In C++, the 0 ends up being an int instead of a pointer when<br />
passed to a varargs function, and things tend to blow up when they read<br />
the garbage high bits. Of course, nobody else does this, so you still<br />
have to use (void*)NULL to be portable.)</p>
<p>Randy.Dunlap 给以肯定回答：</p>
<p>On Mon, 12 Mar 2007, Jan Engelhardt wrote:</p>
<p>&gt;<br />
&gt; On Mar 12 2007 13:37, Cong WANG wrote:<br />
&gt; &gt;<br />
&gt; &gt; The following code is picked from drivers/kvm/kvm_main.c:<br />
&gt; &gt;<br />
&gt; &gt; static struct kvm_vcpu *vcpu_load(struct kvm *kvm, int vcpu_slot)<br />
&gt; &gt; {<br />
&gt; &gt; struct kvm_vcpu *vcpu = &amp;kvm-&gt;vcpus[vcpu_slot];<br />
&gt; &gt;<br />
&gt; &gt; mutex_lock(&amp;vcpu-&gt;mutex);<br />
&gt; &gt; if (unlikely(!vcpu-&gt;vmcs)) {<br />
&gt; &gt; mutex_unlock(&amp;vcpu-&gt;mutex);<br />
&gt; &gt; return 0;<br />
&gt; &gt; }<br />
&gt; &gt; return kvm_arch_ops-&gt;vcpu_load(vcpu);<br />
&gt; &gt; }<br />
&gt; &gt;<br />
&gt; &gt; Obviously, it used 0 rather than NULL when returning a pointer to<br />
&gt; &gt; indicate an error. Should we fix such issue?<br />
&gt;<br />
&gt; Indeed. If it was for me, something like that should throw a compile error.</p>
<p>At least it does throw a sparse warning, and yes, it should<br />
be fixed.</p>
<p>最后我决定提交补丁：</p>
<p>[PATCH]Replace 0 with NULL when returning a pointer</p>
<p>Use NULL to indicate we are returning a pointer rather than an integer<br />
and to eliminate some sparse warnings.</p>
<p>Signed-off-by: Cong WANG &lt;xiyou.wangcong@gmail.com&gt;</p>
<p>---<br />
--- drivers/kvm/kvm_main.c.orig 2007-03-11 21:41:23.000000000 +0800<br />
+++ drivers/kvm/kvm_main.c      2007-03-12 14:26:17.000000000 +0800<br />
@@ -205,7 +205,7 @@ static struct kvm_vcpu *vcpu_load(struct<br />
mutex_lock(&amp;vcpu-&gt;mutex);<br />
if (unlikely(!vcpu-&gt;vmcs)) {<br />
mutex_unlock(&amp;vcpu-&gt;mutex);<br />
-               return 0;<br />
+               return NULL;<br />
}<br />
return kvm_arch_ops-&gt;vcpu_load(vcpu);<br />
}<br />
@@ -799,7 +799,7 @@ struct kvm_memory_slot *gfn_to_memslot(s<br />
&amp;&amp; gfn &lt; memslot-&gt;base_gfn + memslot-&gt;npages)<br />
return memslot;<br />
}<br />
-       return 0;<br />
+       return NULL;<br />
}<br />
EXPORT_SYMBOL_GPL(gfn_to_memslot);</p>
<p></body></html></p>
