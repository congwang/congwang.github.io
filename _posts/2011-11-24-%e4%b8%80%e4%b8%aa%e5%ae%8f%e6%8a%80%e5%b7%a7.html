---
categories:
- Programming
date: 2011-11-24 23:32:15-08:00
layout: post
permalink: /2011/11/24/%e4%b8%80%e4%b8%aa%e5%ae%8f%e6%8a%80%e5%b7%a7/
title: 又一个宏技巧
---
<p><br />

<p>（本文为《C语言编程艺术》的一部分。）</p>
<p>这个技巧是从 Nick Bowler 的一封邮件中看来的，非常有意思，分享一下。</p>
<p>情况是这样的：在 Linux 内核中，有一个函数 kmap_atomic()，它之前带两个参数，而现在，它的第二个参数已经名存实亡了，可以<a href="https://lkml.org/lkml/2011/11/27/3" target="_blank">直接去掉</a>。所以问题就出来了，如何警告使用 kmap_atomic() 的人带有两个参数的形式是过时的？换句话说，怎么才能在用两个参数调用 kmap_atomic() 时发出警告而用一个参数调用时就没有警告？</p>
<p>所以下面的技巧就出来了。</p>
<p>[c]</p>
<p>#define PASTE(a, b) a ## b<br />
#define PASTE2(a, b) PASTE(a, b)</p>
<p>#define NARG_(_2, _1, n, ...) n<br />
#define NARG(...) NARG_(__VA_ARGS__, 2, 1, :)</p>
<p>static inline void *kmap_atomic(struct page *page)<br />
{<br />
	return __kmap_atomic(page);<br />
}</p>
<p>static inline void __deprecated *kmap_atomic_deprecated(struct page *page,<br />
                                                        enum km_type km)<br />
{<br />
        return kmap_atomic(page);<br />
}</p>
<p>#define kmap_atomic1(...) kmap_atomic(__VA_ARGS__)<br />
#define kmap_atomic2(...) kmap_atomic_deprecated(__VA_ARGS__)<br />
#define kmap_atomic(...) PASTE2(kmap_atomic, NARG(__VA_ARGS__)(__VA_ARGS__))<br />
[/c]</p>
<p>这里最精妙的地方当属 NARGS 这个宏的定义，它通过参数个数来决定返回值，进而通过 PASTE2 来选择是 kmap_atomic1，还是 kmap_atomic2，而后者是过期的。如果用户用了两个参数，他就会得到类似下面的编译警告：</p>
<p>drivers/block/drbd/drbd_bitmap.c:973:3: warning: ‘kmap_atomic_deprecated’ is deprecated (declared at /home/wangcong/linux-2.6/include/linux/highmem.h:124)</p>
<p>非常聪明，不是吗？ :)</p>
<p></p>