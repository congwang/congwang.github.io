---
categories:
- Programming
date: 2012-11-30 23:22:20-08:00
layout: post
permalink: /2012/11/30/%e5%8f%91%e9%80%81-igmp-%e5%8c%85%e7%9a%84-perl-%e8%84%9a%e6%9c%ac/
title: 发送 IGMP 包的 Perl 脚本
---
<p><br />
</p>
<p>因为 Fedora 上的 scapy （2.2.0）还不支持 IGMP，所以我用 Perl 写了一个发送 IGMP 的脚本。最初代码来自<a href="http://code.google.com/p/perl-igmp-querier/">这里</a>，原脚本只能发送 IGMP query，我添加了 IGMP leave 和一些命令行选项。用法如下：</p></p>
<pre>
% ./igmp.pl -q 192.168.10.2 224.0.0.22
% ./igmp.pl -l 224.8.8.8 192.168.10.2 224.0.0.22
</pre>
<p>具体代码如下：</p>
<p>[perl]<br />
#! /usr/bin/perl -w</p>
<p># Adapted from    : http://code.google.com/p/perl-igmp-querier/</p>
<p>use strict;<br />
use POSIX;<br />
use Socket qw(inet_pton AF_INET SOCK_RAW);<br />
use Getopt::Long qw(:config no_auto_abbrev);<br />
my $leave;<br />
my $leave_addr;<br />
my $query = 1;<br />
my $help;</p>
<p>sub forgepkt {</p>
<p>  my $src_host = shift;<br />
  my $dst_host = shift;</p>
<p>  my $zero_cksum        = 0;<br />
  my $igmp_proto        = 2;<br />
  my $igmp_type         = $query? '11': '17'; #11 query, 17 leave#<br />
  my $igmp_mrt          = '64';<br />
  my $igmp_pay          = $query? "" : $leave_addr; # 0 for query<br />
  my $igmp_chk          = 0;<br />
  my $igmp_len          = 0;</p>
<p>  my ($igmp_pseudo) = pack('H2H2va4',$igmp_type,$igmp_mrt,$igmp_chk,$igmp_pay);<br />
  $igmp_chk = &amp;checksum($igmp_pseudo);<br />
  $igmp_pseudo = pack('H2H2va4',$igmp_type,$igmp_mrt,$igmp_chk,$igmp_pay);<br />
  $igmp_len = length($igmp_pseudo);</p>
<p>  my $ip_ver            = 4;<br />
  my $ip_len            = 6;<br />
  my $ip_ver_len        = $ip_ver . $ip_len;<br />
  my $ip_tos            = 00;<br />
  my ($ip_tot_len)      = $igmp_len + 20 + 4;<br />
  my $ip_frag_id        = 11243;<br />
  my $ip_frag_flag      = "010";<br />
  my $ip_frag_oset      = "0000000000000";<br />
  my $ip_fl_fr          = $ip_frag_flag . $ip_frag_oset;<br />
  my $ip_ttl            = 1;<br />
  my $ip_opts			= '94040000'; # router alert</p>
<p>  my ($head) = pack('H2H2nnB16C2n',<br />
    $ip_ver_len,$ip_tos,$ip_tot_len,$ip_frag_id,<br />
    $ip_fl_fr,$ip_ttl,$igmp_proto);<br />
  my ($addresses) = pack('a4a4',$src_host,$dst_host);<br />
  my ($pkt) = pack('a*a*H8a*',$head,$addresses,$ip_opts,$igmp_pseudo);</p>
<p>  return $pkt;<br />
}</p>
<p>sub checksum {<br />
 my ($msg) = @_;<br />
 my ($len_msg,$num_short,$short,$chk);<br />
 $len_msg = length($msg);<br />
 $num_short = $len_msg / 2;<br />
 $chk = 0;<br />
 foreach $short (unpack("S$num_short", $msg)) {<br />
  $chk += $short;<br />
 }<br />
 $chk += unpack("C", substr($msg, $len_msg - 1, 1)) if $len_msg % 2;<br />
 $chk = ($chk &gt;&gt; 16) + ($chk &amp; 0xffff);<br />
 return(~(($chk &gt;&gt; 16) + $chk) &amp; 0xffff);<br />
}</p>
<p>sub help {<br />
        my ($exitcode) = @_;</p>
<p>        print &lt; $leave,<br />
	'q|query'       =&gt; $query,<br />
	'h|help'        =&gt; $help,<br />
) or help(0);</p>
<p>help(1) if ($#ARGV &lt; 1);</p>
<p>if ($leave) {<br />
	$query = 0;<br />
	$leave_addr = inet_pton(AF_INET, $leave);<br />
}</p>
<p>my $src = $ARGV[0];<br />
my $dst = $ARGV[1]; # 224.0.0.22, igmp all-hosts</p>
<p>socket(RAW, AF_INET, SOCK_RAW, 255) || die $!;<br />
setsockopt(RAW, 0, 1, 1);</p>
<p>my $src_host = (gethostbyname($src))[4];<br />
my $dst_host = (gethostbyname($dst))[4];<br />
my ($packet) = forgepkt($src_host,$dst_host);<br />
my ($dest) = pack('Sna4x8', AF_INET, 0, $dst_host);</p>
<p># Send general query packet twice for reliability<br />
send(RAW,$packet,0,$dest);<br />
send(RAW,$packet,0,$dest);</p>
<p>[/perl] </p>