---
categories:
- Linux Application
date: 2011-06-18 23:31:29-07:00
layout: post
permalink: /2011/06/18/%e5%85%b3%e4%ba%8e-loop-device/
title: 关于 loop device
---
<p><br />

<p>我们平时挂载一个img文件一般是通过mount -o loop来挂载，而它实际上等价于下面两步：</p>
<p>losetup /dev/loop0 example.img<br />
mount /dev/loop0 /home/you/dir</p>
<p>我们可以看 util-linux-ng 源代码中的 mount/mount.c 文件，在 loop_check() 里有这么一段代码：</p>
<p>[c]</p>
<p>        if (!*loopdev || !**loopdev)<br />
          *loopdev = find_unused_loop_device();<br />
        if (!*loopdev)<br />
          return EX_SYSERR;     /* no more loop devices */<br />
        if (verbose)<br />
          printf(_("mount: going to use the loop device %sn"), *loopdev);</p>
<p>        if ((res = set_loop(*loopdev, *loopfile, offset, sizelimit,<br />
                            opt_encryption, pfd, &amp;loop_opts))) {</p>
<p>[/c]</p>
<p>第一步是把文件和某个空闲的loop设备相关联起来，这里是 /dev/loop0。用的是系统调用ioctl(LOOP_SET_FD)，这样以来对 /dev/loop0 的读写就会转化成对 example.img 的读写了。</p>
<p>第二步就容易理解了，和挂载普通块设备没什么区别了。mount之所以把这两步合为一步是想让你省去手工搜索空闲的loop设备。</p>
<p>现在看看它是怎么工作的：调用 LOOP_SET_FD 的时候内核会把 img 对应的 struct file 关联到设备对应的  lo-&gt;lo_backing_file 上去。同时，内核启动一个内核线程来监控 /dev/loopX 的读写请求（loop_thread()），对于每一个 bio，它都会进行相应的转换，对应到对 lo-&gt;lo_backing_file 上的读写。以写为例，我们可以看do_lo_send_write()：</p>
<p>[c]<br />
static int do_lo_send_write(struct loop_device *lo, struct bio_vec *bvec,<br />
                loff_t pos, struct page *page)<br />
{<br />
        int ret = lo_do_transfer(lo, WRITE, page, 0, bvec-&gt;bv_page,<br />
                        bvec-&gt;bv_offset, bvec-&gt;bv_len, pos &gt;&gt; 9);<br />
        if (likely(!ret))<br />
                return __do_lo_send_write(lo-&gt;lo_backing_file,<br />
                                page_address(page), bvec-&gt;bv_len,<br />
                                pos);<br />
        printk(KERN_ERR "loop: Transfer error at byte offset %llu, "<br />
                        "length %i.n", (unsigned long long)pos, bvec-&gt;bv_len);<br />
        if (ret &gt; 0)<br />
                ret = -EIO;<br />
        return ret;<br />
}</p>
<p>[/c]</p>
<p>而__do_lo_send_write() 直接就调用 file-&gt;f_op-&gt;write() 了。</p>
<p></p>