---
layout: post
title: 几个有用的 malloc 环境变量
date: 2010-05-12 22:16:52.000000000 -07:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Programming
tags: []
meta:
  _publicize_pending: '1'
  original_post_id: '1110'
  _wp_old_slug: '1110'
author:
  login: wangcong2015
  email: wangcong@rocketmail.com
  display_name: wangcong2015
  first_name: ''
  last_name: ''
permalink: "/2010/05/12/%e5%87%a0%e4%b8%aa%e6%9c%89%e7%94%a8%e7%9a%84-malloc-%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<html><body>
<p>或许除了LD_DEBUG等少数几个环境变量，你对glibc的其它环境变量并不熟悉，比如 MALLOC_PERTURB_。</p>
<p>MALLOC_PERTURB_ 很有用，它的作用是指定用来填充 malloc(3) 所分配的内存的内容，单位是字节。我们知道，malloc(3) 并不会对其所分配的内容进行初始化，所以如果直接使用这部分内存会出错。而 MALLOC_PERTURB_ 就是用来解决这个问题的，你可以用它来填充这些内存，然后一旦使用了未初始化的内存，这部分内存就很容易被识别出来。所以它在某种程度上可以帮助我们检测未初始化的 malloc(3) 内存。</p>
<p>需要注意的是，用来初始化 malloc(3) 内存的值是 MALLOC_PERTURB_ 的二进制取反（也就是~MALLOC_PERTURB_），但是 0 会取消掉这个功能。通常我们可以这样来设置：</p>
<p>export MALLOC_PERTURB_=$(($RANDOM % 255 + 1))</p>
<p>另一个是MALLOC_CHECK_，当设置了它时 glibc 就会使用另外一个 malloc(3) 的实现来检查一些简单的内存错误，比如多次 free(3) 同一个地址，off-by-one 错误等。它有三个值：0表示忽视检测到的错误，1表示打印错误到标准错误输出，2表示检测到错误就马上中止程序。更详细的描述可以参考<a href="http://www.gnu.org/s/libc/manual/html_node/Heap-Consistency-Checking.html">手册</a>。</p>
<p>还有几个和 malloc 内存分配策略相关的环境变量是：</p>
<p>MALLOC_MMAP_MAX_<br />
MALLOC_MMAP_THRESHOLD_<br />
MALLOC_TOP_PAD_<br />
MALLOC_TRIM_THRESHOLD_</p>
<p>它们分别等价于 mallopt() 的对应参数，可以参考<a href="http://www.gnu.org/s/libc/manual/html_node/Malloc-Tunable-Parameters.html"> mallopt() 的手册</a>。更详细的介绍<a href="http://www.linuxjournal.com/node/6390/print">见这里</a>。</p>
<p></body></html></p>
